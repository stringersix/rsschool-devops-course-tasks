pipeline {
  agent {
    kubernetes {
      yamlFile 'jenkins/builder.yaml'
    }
  }

  post {
    success {
      mail to: 'sixstringer91@gmail.com',
           subject: "SUCCESS: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
           body: "Job ${env.JOB_NAME} build ${env.BUILD_NUMBER} succeeded.\nCheck it at ${env.BUILD_URL}"
    }
    failure {
      mail to: 'sixstringer91@gmail.com',
           subject: "FAILURE: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
           body: "Job ${env.JOB_NAME} build ${env.BUILD_NUMBER} failed.\nCheck it at ${env.BUILD_URL}"
    }
  }

  stages {
    stage('Prepare Workspace') {
      steps {
        sh 'cp -r ${WORKSPACE}/* /workspace/'
      }
    }

    stage('Tests') {
      steps {
        container('python') {
          sh '''
            pip install flake8
            flake8 /workspace/deploy/app/main.py
          '''
        }
      }
    }

    stage('SonarQube Analysis') {
      steps {
        container('sonar-scanner') {
          withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_TOKEN')]) {
            sh "echo $SONAR_TOKEN"
            sh """
              sonar-scanner \\
                -Dsonar.projectKey=stringersix_rsschool-devops-course-tasks \\
                -Dsonar.organization=stringersix \\
                -Dsonar.host.url=https://sonarcloud.io \\
                -Dsonar.token=\$SONAR_TOKEN \\
                -Dsonar.sources=/workspace/deploy/app
            """
          }
        }
      }
    }

    stage('Build and Push Image') {
      steps {
        container('kaniko') {
          sh '''
            /kaniko/executor --dockerfile=/workspace/deploy/app/Dockerfile \
                             --context=/workspace/deploy/app \
                             --destination=daniluk666/flask:latest \
                             --cleanup
          '''
        }
      }
    }

    stage('Deploy with Helm') {
      steps {
        container('helm') {
          sh '''
            helm upgrade --install flask-app /workspace/deploy/helm \
              --set image.repository=daniluk666/flask \
              --set image.tag=latest \
              --wait
          '''
        }
      }
    }

    stage('Verify Deployment') {
      steps {
        container('python') {
          sh '''
          pip install requests
          python /workspace/deploy/verify.py http://flask-app.jenkins.svc.cluster.local:8080
          '''
        }
      }
    }
  }
}