pipeline {
  agent {
    kubernetes {
      yamlFile 'jenkins/builder.yaml'
    }
  }

  stages {
    stage('Prepare Workspace') {
      steps {
        sh 'cp -r ${WORKSPACE}/* /workspace/'
      }
    }
  stage('Setup Monitoring') {
    steps {
      container('toolbox') {
        sh '''
        cd /workspace
        set +x
        set -o allexport
        . /etc/secrets/.env
        set +o allexport
        set -x
        bash ./monitoring/setup.sh
        '''
      }
    }
  }

  stage('Verify Monitoring Deployment') {
    steps {
      container('toolbox') {
        sh '''
        pip install requests
        echo "Check Prometheus: "
        python3 /workspace/deploy/verify.py http://prom-stack-kube-prometheus-prometheus.monitoring.svc.cluster.local:9090
        echo "Check Grafana: "
        python3 /workspace/deploy/verify.py http://prom-stack-grafana.monitoring.svc.cluster.local
      '''
      }
    }
  }
  
  //   stage('Print env') {
  //     steps {
  //       sh 'echo $APP_ENV && echo $APP_PORT'
  //     }
  //   }

  //   stage('Tests') {
  //     steps {
  //       container('toolbox') {
  //         sh '''
  //           set +e

  //           pip install flask pytest
  //           cd /workspace/deploy
  //           echo "Running pytest tests..."
  //           pytest test.py -q --disable-warnings > pytest_report.txt
  //           exit_code=$?

  //           echo "pytest exit code: $exit_code"

  //           if [ $exit_code -ne 0 ]; then
  //             echo "❌ Pytest reported failed tests:"
  //             cat pytest_report.txt
  //             exit $exit_code
  //           else
  //             echo "✅ Pytest passed all tests."
  //           fi

  //           set -e
  //         '''
  //       }
  //     }
  //   }

  //   stage('Deploy flask-app with Helm') {
  //     steps {
  //       container('toolbox') {
  //         sh '''
  //           helm upgrade --install flask-app /workspace/deploy/helm \
  //             --set image.repository=daniluk666/flask \
  //             --set image.tag=latest \
  //             --wait
  //         '''
  //       }
  //     }
  //   }

  //   stage('Deploy monitoring with Helm') {
  //     steps() {
  //       container('toolbox') {
  //         sh '''
  //         	helm upgrade --install prom-stack prometheus-community/kube-prometheus-stack \
  // 		        --namespace monitoring --create-namespace \
  // 		        -f monitoring/helm/values.yaml \
	// 	          --wait
  //         '''
  //         sh '''
  //         	helm upgrade --install prom-stack prometheus-community/kube-prometheus-stack \
  // 		        --namespace monitoring --create-namespace \
  // 		        -f monitoring/helm/values.yaml \
	// 	          --wait
  //         '''
  //       }
  //     }
  //   }

  //   stage('Verify Deployment') {
  //     steps {
  //       container('toolbox') {
  //         sh '''
  //         pip install requests
  //         python /workspace/deploy/verify.py http://flask-app.jenkins.svc.cluster.local:8080
  //         '''
  //       }
  //     }
  //   }
  }
}